generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////

enum Role {
  USER
  ADMIN
}

enum PostStatus {
  VISIBLE
  HIDDEN
  DELETED
}

enum PostVisibility {
  PUBLIC
  FOLLOWERS
  PRIVATE
  ANONYMOUS
}

enum PostType {
  NORMAL
  POLL
}

enum PostContentFormat {
  PLAIN_TEXT
  TIPTAP_JSON
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
}

enum NotificationType {
  POST_LIKE
  POST_COMMENT
  FOLLOW
  NEW_POST
}

enum VoteType {
  UP
  DOWN
}

enum XPAction {
  POST
  COMMENT
  LIKE_RECEIVED
}

//////////////////////////////////////////////////
// USERS
//////////////////////////////////////////////////

model User {
  id          Int      @id @default(autoincrement())
  fullName    String
  userName    String?  @unique
  email       String   @unique
  password    String?
  role        Role     @default(USER)
  avatarUrl   String?
  bio         String?
  birthday    DateTime?
  gender      String?
  level       Int      @default(1)
  xp          Int      @default(0)
  googleId    String?  @unique
  facebookId  String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  posts       Post[]
  comments    Comment[]
  likes       PostLike[]
  followsFrom UserFollow[] @relation("Follower")
  followsTo   UserFollow[] @relation("Following")
  xpLogs      XPLog[]
  badges      UserBadge[]
  notifications Notification[]
  reports     Report[] @relation("Reporter")

  tuviCharts UserTuViChart[]
  commentVotes CommentVote[]
  collections  Collection[]
  bookmarks    Bookmark[]
  pollVotes    PollVote[]
  postViews    PostView[]
}

//////////////////////////////////////////////////
// FOLLOW SYSTEM
//////////////////////////////////////////////////

model UserFollow {
  followerId  Int
  followingId Int
  createdAt   DateTime @default(now())

  follower  User @relation("Follower", fields: [followerId], references: [id])
  following User @relation("Following", fields: [followingId], references: [id])

  @@id([followerId, followingId])
}

//////////////////////////////////////////////////
// POSTS
//////////////////////////////////////////////////

model Post {
  id         Int           @id @default(autoincrement())
  userId     Int
  title      String?
  content    String?
  contentJson Json?
  contentText String?
  contentFormat PostContentFormat @default(TIPTAP_JSON)
  type       PostType      @default(NORMAL)
  visibility PostVisibility @default(PUBLIC)
  status     PostStatus    @default(VISIBLE)
  isDraft    Boolean       @default(false)
  deletedAt  DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  user       User          @relation(fields: [userId], references: [id])
  comments   Comment[]
  likes      PostLike[]
  tags       PostTag[]
  edits      PostEditHistory[]
  poll       Poll?
  views      PostView[]
  reports    Report[]
  bookmarks    Bookmark[]
}

//////////////////////////////////////////////////
// POST EDIT HISTORY
//////////////////////////////////////////////////

model PostEditHistory {
  id        Int      @id @default(autoincrement())
  postId    Int
  oldContent String?
  editedAt  DateTime @default(now())

  post      Post @relation(fields: [postId], references: [id])
}

//////////////////////////////////////////////////
// COMMENTS
//////////////////////////////////////////////////

model Comment {
  id          Int      @id @default(autoincrement())
  postId      Int
  userId      Int
  parentId    Int?
  content     String
  isAnonymous Boolean  @default(false)
  createdAt   DateTime @default(now())

  post        Post     @relation(fields: [postId], references: [id])
  user        User     @relation(fields: [userId], references: [id])
  parent      Comment? @relation("CommentReply", fields: [parentId], references: [id])
  replies     Comment[] @relation("CommentReply")
  votes       CommentVote[]
  reports     Report[]
}

//////////////////////////////////////////////////
// COMMENT VOTES
//////////////////////////////////////////////////

model CommentVote {
  commentId Int
  userId    Int
  type      VoteType

  comment   Comment @relation(fields: [commentId], references: [id])
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([commentId, userId])
}

//////////////////////////////////////////////////
// POST LIKE
//////////////////////////////////////////////////

model PostLike {
  postId    Int
  userId    Int
  createdAt DateTime @default(now())

  post      Post @relation(fields: [postId], references: [id])
  user      User @relation(fields: [userId], references: [id])

  @@id([postId, userId])
}

//////////////////////////////////////////////////
// TAGS
//////////////////////////////////////////////////

model Tag {
  id    Int    @id @default(autoincrement())
  name  String @unique

  posts PostTag[]
}

model PostTag {
  postId Int
  tagId  Int

  post   Post @relation(fields: [postId], references: [id])
  tag    Tag  @relation(fields: [tagId], references: [id])

  @@id([postId, tagId])
}

//////////////////////////////////////////////////
// BOOKMARK & COLLECTION
//////////////////////////////////////////////////

model Collection {
  id        Int      @id @default(autoincrement())
  userId    Int
  name      String
  createdAt DateTime @default(now())

  user      User @relation(fields: [userId], references: [id])
  bookmarks Bookmark[]
}

model Bookmark {
  userId       Int
  postId       Int
  collectionId Int?
  createdAt    DateTime @default(now())

  user        User @relation(fields: [userId], references: [id])
  post        Post @relation(fields: [postId], references: [id])
  collection  Collection? @relation(fields: [collectionId], references: [id])
  
  @@id([userId, postId])
}

//////////////////////////////////////////////////
// POLL
//////////////////////////////////////////////////

model Poll {
  id        Int      @id @default(autoincrement())
  postId    Int      @unique
  expiresAt DateTime?

  post      Post @relation(fields: [postId], references: [id])
  options   PollOption[]
}

model PollOption {
  id      Int    @id @default(autoincrement())
  pollId  Int
  text    String

  poll    Poll @relation(fields: [pollId], references: [id])
  votes   PollVote[]
}

model PollVote {
  pollOptionId Int
  userId       Int
  createdAt    DateTime @default(now())

  option       PollOption @relation(fields: [pollOptionId], references: [id])
  user         User       @relation(fields: [userId], references: [id])

  @@id([pollOptionId, userId])
}

//////////////////////////////////////////////////
// GAMIFICATION
//////////////////////////////////////////////////

model XPLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    XPAction
  value     Int
  createdAt DateTime @default(now())

  user      User @relation(fields: [userId], references: [id])
}

model Badge {
  id          Int    @id @default(autoincrement())
  name        String
  description String?

  users       UserBadge[]
}

model UserBadge {
  userId   Int
  badgeId  Int
  earnedAt DateTime @default(now())

  user     User  @relation(fields: [userId], references: [id])
  badge    Badge @relation(fields: [badgeId], references: [id])

  @@id([userId, badgeId])
}

//////////////////////////////////////////////////
// NOTIFICATIONS
//////////////////////////////////////////////////

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      NotificationType
  refId     Int?
  content   String
  isRead    Boolean @default(false)
  createdAt DateTime @default(now())

  user      User @relation(fields: [userId], references: [id])
}

//////////////////////////////////////////////////
// REPORTS
//////////////////////////////////////////////////

model Report {
  id         Int      @id @default(autoincrement())
  reporterId Int
  postId     Int?
  commentId  Int?
  reason     String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime @default(now())

  reporter   User    @relation("Reporter", fields: [reporterId], references: [id])
  post       Post?   @relation(fields: [postId], references: [id])
  comment    Comment? @relation(fields: [commentId], references: [id])
}

//////////////////////////////////////////////////
// POST VIEW
//////////////////////////////////////////////////

model PostView {
  postId   Int
  userId   Int?
  viewedAt DateTime @default(now())

  post     Post @relation(fields: [postId], references: [id])
  user     User? @relation(fields: [userId], references: [id])

  @@id([postId, viewedAt])
}

enum TuViChartStatus {
  GENERATED   
  AI_INTERPRETED 
  EXPERT_INTERPRETED 
  DELETED
}

model UserTuViChart {
  id               Int                @id @default(autoincrement())           
  userId           Int
  birthDate        DateTime           
  birthHour        Float              
  gender           String             
  birthPlace       String?            
  isLunar          Boolean            
  can              String             
  chi              String             
  menhElement      String             
  chartData        Json               
  interpretationAI String?            
  status           TuViChartStatus    
  createdAt        DateTime           
  updatedAt        DateTime           

  user             User               @relation(fields: [userId], references: [id])
}