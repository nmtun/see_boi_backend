generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////

enum Role {
  USER
  ADMIN
}

enum PostStatus {
  VISIBLE
  HIDDEN
  DELETED
}

enum PostVisibility {
  PUBLIC
  FOLLOWERS
  PRIVATE
  ANONYMOUS
}

enum PostType {
  NORMAL
  POLL
}

enum PostContentFormat {
  PLAIN_TEXT
  TIPTAP_JSON
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
}

enum NotificationType {
  POST_LIKE
  POST_COMMENT
  FOLLOW
  NEW_POST
}

enum VoteType {
  UP
  DOWN
}

enum XPAction {
  POST
  COMMENT
  LIKE_RECEIVED
}

enum ImageType {
  POST
  COMMENT
  USER
}

enum CommentCategory {
  POSITIVE
  NEGATIVE
  NEUTRAL
  TOXIC
}

//////////////////////////////////////////////////
// USERS
//////////////////////////////////////////////////

model User {
  id         Int       @id @default(autoincrement())
  fullName   String
  userName   String?   @unique
  email      String    @unique
  password   String?
  role       Role      @default(USER)
  avatarUrl  String?
  bio        String?
  birthday   DateTime?
  gender     String?
  level      Int       @default(1)
  xp         Int       @default(0)
  googleId   String?   @unique
  facebookId String?   @unique
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  posts         Post[]
  comments      Comment[]
  likes         PostLike[]
  followsFrom   UserFollow[]   @relation("Follower")
  followsTo     UserFollow[]   @relation("Following")
  xpLogs        XPLog[]
  badges        UserBadge[]
  notifications Notification[]
  reports       Report[]       @relation("Reporter")

  tuviCharts   UserTuViChart[]
  commentVotes CommentVote[]
  collections  Collection[]
  bookmarks    Bookmark[]
  pollVotes    PollVote[]
  postViews    PostView[]
  faceLandmarks UserFaceLandmarks[]
  images       Image[]
}

//////////////////////////////////////////////////
// FOLLOW SYSTEM
//////////////////////////////////////////////////

model UserFollow {
  followerId  Int
  followingId Int
  createdAt   DateTime @default(now())

  follower  User @relation("Follower", fields: [followerId], references: [id])
  following User @relation("Following", fields: [followingId], references: [id])

  @@id([followerId, followingId])
}

//////////////////////////////////////////////////
// POSTS
//////////////////////////////////////////////////

model Post {
  id            Int               @id @default(autoincrement())
  userId        Int
  title         String?
  content       String?
  contentJson   Json?
  contentText   String?
  contentFormat PostContentFormat @default(TIPTAP_JSON)
  thumbnailUrl  String?
  type          PostType          @default(NORMAL)
  visibility    PostVisibility    @default(PUBLIC)
  status        PostStatus        @default(VISIBLE)
  isDraft       Boolean           @default(false)
  deletedAt     DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  user      User              @relation(fields: [userId], references: [id])
  comments  Comment[]
  likes     PostLike[]
  tags      PostTag[]
  edits     PostEditHistory[]
  poll      Poll?
  views     PostView[]
  reports   Report[]
  bookmarks Bookmark[]
  images    Image[]
}

//////////////////////////////////////////////////
// POST EDIT HISTORY
//////////////////////////////////////////////////

model PostEditHistory {
  id         Int      @id @default(autoincrement())
  postId     Int
  oldContent String?
  editedAt   DateTime @default(now())

  post Post @relation(fields: [postId], references: [id])
}

//////////////////////////////////////////////////
// COMMENTS
//////////////////////////////////////////////////

model Comment {
  id          Int              @id @default(autoincrement())
  postId      Int
  userId      Int
  content     String
  parentId    Int?
  isAnonymous Boolean          @default(false)
  category    CommentCategory? @default(NEUTRAL)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @default(now()) @updatedAt

  post    Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  Comment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[]     @relation("CommentReplies")
  votes   CommentVote[]
  reports Report[]
  images  Image[]

  @@index([postId])
  @@index([userId])
  @@index([parentId])
}

//////////////////////////////////////////////////
// COMMENT VOTES
//////////////////////////////////////////////////

model CommentVote {
  commentId Int
  userId    Int
  type      VoteType

  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([commentId, userId])
}

//////////////////////////////////////////////////
// POST LIKE
//////////////////////////////////////////////////

model PostLike {
  postId    Int
  userId    Int
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@id([postId, userId])
}

//////////////////////////////////////////////////
// TAGS
//////////////////////////////////////////////////

model Tag {
  id   Int    @id @default(autoincrement())
  name String @unique

  posts PostTag[]
}

model PostTag {
  postId Int
  tagId  Int

  post Post @relation(fields: [postId], references: [id])
  tag  Tag  @relation(fields: [tagId], references: [id])

  @@id([postId, tagId])
}

//////////////////////////////////////////////////
// BOOKMARK & COLLECTION
//////////////////////////////////////////////////

model Collection {
  id        Int      @id @default(autoincrement())
  userId    Int
  name      String
  createdAt DateTime @default(now())

  user      User       @relation(fields: [userId], references: [id])
  bookmarks Bookmark[]
}

model Bookmark {
  userId       Int
  postId       Int
  collectionId Int?
  createdAt    DateTime @default(now())

  user       User        @relation(fields: [userId], references: [id])
  post       Post        @relation(fields: [postId], references: [id])
  collection Collection? @relation(fields: [collectionId], references: [id])

  @@id([userId, postId])
}

//////////////////////////////////////////////////
// POLL
//////////////////////////////////////////////////

model Poll {
  id        Int       @id @default(autoincrement())
  postId    Int       @unique
  expiresAt DateTime?

  post    Post         @relation(fields: [postId], references: [id])
  options PollOption[]
}

model PollOption {
  id     Int    @id @default(autoincrement())
  pollId Int
  text   String

  poll  Poll       @relation(fields: [pollId], references: [id])
  votes PollVote[]
}

model PollVote {
  pollOptionId Int
  userId       Int
  createdAt    DateTime @default(now())

  option PollOption @relation(fields: [pollOptionId], references: [id])
  user   User       @relation(fields: [userId], references: [id])

  @@id([pollOptionId, userId])
}

//////////////////////////////////////////////////
// GAMIFICATION
//////////////////////////////////////////////////

model XPLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    XPAction
  value     Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model Badge {
  id          Int     @id @default(autoincrement())
  name        String
  description String?

  users UserBadge[]
}

model UserBadge {
  userId   Int
  badgeId  Int
  earnedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  badge Badge @relation(fields: [badgeId], references: [id])

  @@id([userId, badgeId])
}

//////////////////////////////////////////////////
// NOTIFICATIONS
//////////////////////////////////////////////////

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  type      NotificationType
  refId     Int?
  content   String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id])
}

//////////////////////////////////////////////////
// REPORTS
//////////////////////////////////////////////////

model Report {
  id         Int          @id @default(autoincrement())
  reporterId Int
  postId     Int?
  commentId  Int?
  reason     String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())

  reporter User     @relation("Reporter", fields: [reporterId], references: [id])
  post     Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment  Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////
// POST VIEW
//////////////////////////////////////////////////

model PostView {
  postId   Int
  userId   Int?
  viewedAt DateTime @default(now())

  post Post  @relation(fields: [postId], references: [id])
  user User? @relation(fields: [userId], references: [id])

  @@id([postId, viewedAt])
}

//////////////////////////////////////////////////
// IMAGE
//////////////////////////////////////////////////

model Image {
  id        Int       @id @default(autoincrement())
  url       String
  type      ImageType
  entityId  Int
  postId    Int?
  commentId Int?
  userId    Int?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([type, entityId])
  @@index([postId])
  @@index([commentId])
  @@index([userId])
}

//////////////////////////////////////////////////
// TU VI CHART
//////////////////////////////////////////////////

enum TuViChartStatus {
  GENERATED
  AI_INTERPRETED
  EXPERT_INTERPRETED
  DELETED
}

model UserTuViChart {
  id               Int             @id @default(autoincrement())
  userId           Int
  birthDate        DateTime
  birthHour        Float
  gender           String
  birthPlace       String?
  isLunar          Boolean
  can              String
  chi              String
  menhElement      String
  chartData        Json
  interpretationAI String?
  status           TuViChartStatus
  createdAt        DateTime
  updatedAt        DateTime
  user             User               @relation(fields: [userId], references: [id])
}

model UserFaceLandmarks {
  id        Int      @id @default(autoincrement())
  userId    Int
  metrics   Json
  name      String  
  dob       DateTime 
  gender    String  
  report    Json
  landmarks Json
  tags      String[]
  imageUrl  String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([tags])
}